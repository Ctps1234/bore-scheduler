From cf6dc50fe7034d00fbd9f67239488df12910e7e8 Mon Sep 17 00:00:00 2001
From: Masahito S <firelzrd@gmail.com>
Date: Sat, 10 Feb 2024 11:21:19 +0900
Subject: [PATCH] Fix: reweight_eevdf() Rescale (deadline - se->vruntime)
 instead of (deadline - avg_vruntime)

---
 kernel/sched/fair.c | 20 ++++++++++----------
 1 file changed, 10 insertions(+), 10 deletions(-)

diff --git a/kernel/sched/fair.c b/kernel/sched/fair.c
index 533547e3c9..8459cbb2aa 100644
--- a/kernel/sched/fair.c
+++ b/kernel/sched/fair.c
@@ -3753,14 +3753,7 @@ static void reweight_eevdf(struct cfs_rq *cfs_rq, struct sched_entity *se,
 	 *	   = V  - (V - v) * w / w'
 	 *	   = V  - vl * w / w'
 	 *	   = V  - vl'
-	 */
-	if (avruntime != se->vruntime) {
-		vlag = (s64)(avruntime - se->vruntime);
-		vlag = div_s64(vlag * old_weight, weight);
-		se->vruntime = avruntime - vlag;
-	}
-
-	/*
+	 *
 	 * DEADLINE
 	 * ========
 	 *
@@ -3772,9 +3765,16 @@ static void reweight_eevdf(struct cfs_rq *cfs_rq, struct sched_entity *se,
 	 *	   = V  - (V - v)*w/w' + (d - v)*w/w'
 	 *	   = V  + (d - V)*w/w'
 	 */
-	vslice = (s64)(se->deadline - avruntime);
+	vslice = (s64)(se->deadline - se->vruntime);
+
+	if (avruntime != se->vruntime) {
+		vlag = (s64)(avruntime - se->vruntime);
+		vlag = div_s64(vlag * old_weight, weight);
+		se->vruntime = avruntime - vlag;
+	}
+
 	vslice = div_s64(vslice * old_weight, weight);
-	se->deadline = avruntime + vslice;
+	se->deadline = se->vruntime + vslice;
 }
 
 static void reweight_entity(struct cfs_rq *cfs_rq, struct sched_entity *se,
-- 
2.34.1

